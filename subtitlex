#!/bin/bash

# A script to add subtitles to a video.
# The main controls we want to provide the user are:
# - Bake mode (optional)
# - Model size

usage() {
    echo "Usage: $0 [OPTIONS] <input_video_file>"
    echo "Add subtitles to a video file using WhisperX."
    echo ""
    echo "Arguments:"
    echo "  <input_video_file>   The video file to process."
    echo ""
    echo "Options:"
    echo "  -o, --output <file>  Specify the output file name (default: subtitle-<input_video_file>)"
    echo "  -b, --bake           Bake subtitles directly into the video"
    echo "  -m, --model <size>   Specify the Whisper model size (small, medium, large). Default: medium"
    echo "  -h, --help           Display this help message"
    echo ""
    echo "Example:"
    echo "  $0 my_video.mp4"
    echo "  $0 -b -o output.mp4 input.mp4"
    exit 1
}

INPUT=""
TARGET=""
BAKE=""
SIZE=""

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --output|-o)
            TARGET="$2"
            shift
            shift
            ;;
        --bake|-b)
            BAKE="--bake"
            shift
            ;;
        --model|-m)
            SIZE="$2"
            shift
            shift
            ;;
        --help|-h)
            usage
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            ;;
        *)
            if [ -z "$INPUT" ]; then
                INPUT="$1"
            else
                echo "Unknown parameter: $1"
                usage
            fi
            shift
            ;;
    esac
done

[ -z "$INPUT" ] && echo "Error: No input video file provided." && usage
[ -z "$TARGET" ] && TARGET="subtitle-$(basename "$INPUT")"

# Default model size to small if not specified
if [ -z "$SIZE" ]; then
    SIZE="small"
fi

# Set the model tag based on the size
case $SIZE in
    small)
        MODEL_TAG="gencore/whisperx-speech-to-text:small"
        ;;
    medium)
        MODEL_TAG="gencore/whisperx-speech-to-text:medium"
        ;;
    large)
        MODEL_TAG="gencore/whisperx-speech-to-text:large-v3"
        ;;
    *)
        echo "Invalid model size: $SIZE. Please use small, medium, or large."
        exit 1
        ;;
esac

mkdir -p "$(dirname "$TARGET")"
touch "$TARGET"
docker run -v "$PWD":/audio --rm -i $MODEL_TAG $BAKE --output "$TARGET" "$INPUT"